# 误差计算代码检查报告

## 发现的潜在问题

### 问题1：测试数据格式处理

**代码位置：** `setpinn/util.py:74-78`

```python
pred = model(data["x_test"], data["t_test"]).detach().cpu().numpy().reshape(test_points, test_points)

# Analytical solution
x, t = data["x_test"].detach().cpu().numpy(), data["t_test"].detach().cpu().numpy()
u = analytical_sol(exp_name.split("-")[1], x, t).reshape(test_points, test_points)
```

**潜在问题：**
1. **模型输出形状**：对于setpinns模型，如果输入是`[N, 1]`格式，模型输出可能是`[N, 1]`，直接reshape可能不正确
2. **analytical_sol输入格式**：`x`和`t`从`data["x_test"]`提取，形状是`[N, 1]`，需要先flatten或squeeze成1D数组

### 问题2：误差计算公式

**当前代码：**
```python
rl1 = np.sum(np.abs(u - pred)) / np.sum(np.abs(u))
rl2 = np.sqrt(np.sum((u - pred) ** 2) / np.sum(u**2))
```

**公式检查：**
- Relative L1: ✓ 正确
- Relative L2 (rRMSE): ✓ 正确（与论文公式一致）

论文中的rRMSE公式：
$$\text{rRMSE} = \sqrt{\frac{\sum_{n=1}^N (\hat{y}_n - y_n)^2}{\sum_{n=1}^N y_n^2}}$$

代码实现：
```python
rl2 = np.sqrt(np.sum((u - pred) ** 2) / np.sum(u**2))
```
✓ **公式正确**

### 问题3：数据形状处理

**检查点：**
1. `data["x_test"]`和`data["t_test"]`的形状应该是`[N, 1]`
2. 模型输出可能需要处理（取决于模型类型）
3. `analytical_sol`函数需要1D数组输入

## 建议的修复

### 修复1：确保数据格式正确

```python
# 在eval_and_plot函数中
model.eval()
with torch.no_grad():
    # 获取模型输出
    pred_tensor = model(data["x_test"], data["t_test"])
    
    # 处理不同模型的输出格式
    if pred_tensor.dim() == 3:  # [B, S, 1] format
        pred = pred_tensor.squeeze(-1).reshape(-1).cpu().numpy()
    elif pred_tensor.dim() == 2:  # [N, 1] format
        pred = pred_tensor.squeeze().cpu().numpy()
    else:
        pred = pred_tensor.reshape(-1).cpu().numpy()
    
    # Reshape to grid
    pred = pred.reshape(test_points, test_points)

# Analytical solution - 确保输入是1D数组
x = data["x_test"].detach().cpu().numpy()
t = data["t_test"].detach().cpu().numpy()

# 处理形状
if x.ndim == 2:
    x = x.squeeze()
    t = t.squeeze()
elif x.ndim == 3:
    x = x.squeeze(-1).reshape(-1)
    t = t.squeeze(-1).reshape(-1)

u = analytical_sol(exp_name.split("-")[1], x, t).reshape(test_points, test_points)
```

## 验证误差计算是否正确

从您的输出看：
- Relative L1 error: 1.0646
- Relative L2 error: 1.1199

**误差>1说明：**
- 预测误差的绝对值总和 > 真实值的绝对值总和
- 这意味着预测非常不准确，甚至可能符号都错了

**如果误差计算正确，这可能的原因：**
1. 模型确实没有训练好（最可能）
2. 模型输出和真实值的形状/顺序不匹配
3. 数据预处理有问题

## 建议的调试步骤

1. **检查预测值的范围**：
   ```python
   print(f"Predicted range: [{pred.min():.4f}, {pred.max():.4f}]")
   print(f"Exact range: [{u.min():.4f}, {u.max():.4f}]")
   ```

2. **检查数据形状**：
   ```python
   print(f"x_test shape: {data['x_test'].shape}")
   print(f"pred_tensor shape: {pred_tensor.shape}")
   print(f"pred shape: {pred.shape}")
   print(f"u shape: {u.shape}")
   ```

3. **可视化对比**：
   - 查看生成的PDF图像，看预测是否合理

## 结论

误差计算公式本身是**正确的**，但数据格式处理可能有问题。主要需要检查：
1. 模型输出的形状是否正确
2. analytical_sol的输入格式是否正确
3. reshape操作是否匹配数据的实际形状

如果误差计算代码有问题，通常会导致：
- 形状不匹配错误
- 或者计算结果为NaN/Inf

您的代码能运行并输出结果，说明基本的形状匹配是正确的，但可能细节上有问题导致误差计算不准确。

